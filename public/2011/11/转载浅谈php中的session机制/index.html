<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<title> 【转载】浅谈PHP中的Session机制 &middot; 趣味互联网 </title>
    
    <meta name="mobile-web-app-capable" content="yes">
	<meta name="generator" content="Hugo 0.15-DEV" />
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="趣味互联网">
	
    
    <meta name="msapplication-TileImage" content="images/touch/ms-touch-icon-144x144-precomposed.png">
    <meta name="msapplication-TileColor" content="#3372DF">
    <link rel="stylesheet" href="http://:1313/tmp//css/typo.css">
    <link rel="stylesheet" href="http://:1313/tmp//css/style.css">
    <link rel="stylesheet" href="http://:1313/tmp//css/codecolorer.css">
	
	<link href="" rel="alternate" type="application/rss+xml" title="趣味互联网" />
  	<script type="text/javascript" src="http://:1313/tmp//js/jquery-2.1.4.min.js"></script>
  </head>
 <body class="typo">
	  <div id="wrapper">
		  <div class="box">
			  <div class="header">
			  <h1>【转载】浅谈PHP中的Session机制</h1>
			  <small>2011-11-28,&nbsp;					Tom Heng
,&nbsp; <a href="http://:1313/tmp/">趣味互联网</a></small>
		 	  </div>
			  <div class="main">
				  <div class="catelog" style="display:none;">
	  			  <ol id="table">
	  			    <li><a href="#section1">关于 <i class="serif">Typo.css</i></a></li>
	  			    <li><a href="#section2">排版实例</a>
	  			      <ul>
	  			        <li><a href="#section2-1">例1：论语学而篇第一</a></li>
	  			        <li><a href="#section2-2">例2：英文排版</a></li>
	  			      </ul>
	  			    </li>
	  			    <li><a href="#section3">附录</a>
	  			      <ul>
	  			        <li><a href="#appendix1"><i class="serif">Typo.css</i> 排版偏重点</a></li>
	  			        <li><a href="#appendix2">开源许可</a></li>
	  			      </ul>
	  			    </li>
	  			  </ol>
				  </div>
				  <div class="content">
		        <p>做web开发，必然会涉及到Session，这是由于http协议本身是无状态的（每次响应都是独立的，彼此间没有联系），所以如果需要在页面跳转间保持某个用户的身份，就要在每次连接时告诉服务器端你的唯一标示号，即Session ID。这样，服务器端便可通过Session ID得到所需的数据。</p>

<p>在PHP中，Session是通过$_SESSION这个全局变量来set/get的，不过在使用之前要先初始化。初始化是通过session_start函数（如果php.ini中将session.auto_start设为1，则会自动初始化），之后PHP会为request自动生成一个唯一随机数作为Session ID，生成算法默认提供了MD5 (128 bits) 和SHA-1 (160 bits)，由php.ini中session.hash_function设定。其实也可以自定义，比如在随机数基础上将来访者的IP地址也加入到算法中，像CodeIgniter1.7.2中代码：</p>

<div class="codecolorer-container php blackboard" style="overflow:auto;white-space:nowrap;">
  <table cellspacing="0" cellpadding="0">
    <tr>
      <td class="line-numbers">
        <div>
          1<br />2<br />3<br />4<br />5<br />6<br />7<br />8<br />
        </div>
      </td>
      
      <td>
        <div class="php codecolorer">
          <span class="re0">$sessid</span> <span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span><br /> <span class="kw1">while</span> <span class="br0">&#40;</span><a href="http://www.php.net/strlen"><span class="kw3">strlen</span></a><span class="br0">&#40;</span><span class="re0">$sessid</span><span class="br0">&#41;</span> <span class="sy0"><</span> <span class="nu0">32</span><span class="br0">&#41;</span><br /> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; <span class="re0">$sessid</span> <span class="sy0">.=</span> <a href="http://www.php.net/mt_rand"><span class="kw3">mt_rand</span></a><span class="br0">&#40;</span><span class="nu0"></span><span class="sy0">,</span> <a href="http://www.php.net/mt_getrandmax"><span class="kw3">mt_getrandmax</span></a><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> <span class="br0">&#125;</span><br /> <span class="co1">// To make the session ID even more secure we'll combine it with the user's IP</span><br /> <span class="re0">$sessid</span> <span class="sy0">.=</span> <span class="re0">$this</span><span class="sy0">-></span><span class="me1">CI</span><span class="sy0">-></span><span class="me1">input</span><span class="sy0">-></span><span class="me1">ip_address</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> <span class="re0">$sessid</span> <span class="sy0">=</span> <a href="http://www.php.net/md5"><span class="kw3">md5</span></a><span class="br0">&#40;</span><a href="http://www.php.net/uniqid"><span class="kw3">uniqid</span></a><span class="br0">&#40;</span><span class="re0">$sessid</span><span class="sy0">,</span> <span class="kw4">TRUE</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
        </div>
      </td>
    </tr>
  </table>
</div>

<p>生成的ID存放在服务器的某一目录下，这由php.ini中session.save_path配置。如果你选择默认的文件式session存储，那么可能会遇到大量session文件导致IO性能下降，这个问题可以通过调节save_path来优化，具体请看<a href="http://apps.hi.baidu.com/share/detail/27379034">大量php session临时文件带来的服务器效率问题</a>。如果要在多个服务器中同步session id，你可以将其存放在数据库或共享缓存中。这需要你自定义一系列Session的读写方法，并在调用session_start函数前先设定好，以下面代码为例(来自php document中的一段示例代码)：</p>

<div class="codecolorer-container sql blackboard" style="overflow:auto;white-space:nowrap;">
  <table cellspacing="0" cellpadding="0">
    <tr>
      <td class="line-numbers">
        <div>
          1<br />2<br />3<br />4<br />5<br />6<br />
        </div>
      </td>
      
      <td>
        <div class="sql codecolorer">
          <span class="kw1">CREATE</span> <span class="kw1">TABLE</span> <span class="st0">`ws_sessions`</span> <span class="br0">&#40;</span> <br /> &nbsp; <span class="st0">`session_id`</span> <span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">255</span><span class="br0">&#41;</span> <span class="kw1">BINARY</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span> <span class="kw1">DEFAULT</span> <span class="st0">''</span><span class="sy0">,</span> <br /> &nbsp; <span class="st0">`session_expires`</span> <span class="kw1">INT</span><span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span> <span class="kw1">UNSIGNED</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span> <span class="kw1">DEFAULT</span> <span class="st0">'0'</span><span class="sy0">,</span> <br /> &nbsp; <span class="st0">`session_data`</span> text<span class="sy0">,</span> <br /> &nbsp; <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span> &nbsp;<span class="br0">&#40;</span><span class="st0">`session_id`</span><span class="br0">&#41;</span> <br /> <span class="br0">&#41;</span> <span class="kw1">TYPE</span><span class="sy0">=</span>InnoDB;
        </div>
      </td>
    </tr>
  </table>
</div>

<div class="codecolorer-container php blackboard" style="overflow:auto;white-space:nowrap;">
  <table cellspacing="0" cellpadding="0">
    <tr>
      <td class="line-numbers">
        <div>
          1<br />2<br />3<br />4<br />5<br />6<br />7<br />8<br />9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18<br />19<br />20<br />21<br />22<br />23<br />24<br />25<br />26<br />27<br />28<br />29<br />30<br />31<br />32<br />33<br />34<br />35<br />36<br />37<br />38<br />39<br />40<br />41<br />42<br />43<br />44<br />45<br />46<br />47<br />48<br />49<br />50<br />51<br />52<br />53<br />54<br />55<br />56<br />57<br />58<br />59<br />60<br />61<br />62<br />63<br />64<br />65<br />66<br />67<br />68<br />69<br />70<br />71<br />72<br />73<br />74<br />75<br />76<br />77<br />78<br />79<br />80<br />81<br />82<br />83<br />84<br />85<br />86<br />87<br />88<br />89<br />90<br />91<br />92<br />93<br />94<br />
        </div>
      </td>
      
      <td>
        <div class="php codecolorer">
          <span class="kw2"><?php</span> <br /> <span class="kw2">class</span> session <span class="br0">&#123;</span> <br /> &nbsp; &nbsp;<span class="co1">// session-lifetime </span><br /> &nbsp; &nbsp;<span class="kw2">var</span> <span class="re0">$lifeTime</span><span class="sy0">;</span> <br /> &nbsp; &nbsp;<span class="co1">// mysql-handle </span><br /> &nbsp; &nbsp;<span class="kw2">var</span> <span class="re0">$dbHandle</span><span class="sy0">;</span> <br /> &nbsp; &nbsp;<span class="kw2">function</span> open<span class="br0">&#40;</span><span class="re0">$savePath</span><span class="sy0">,</span> <span class="re0">$sessName</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">// get session-lifetime </span><br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="re0">$this</span><span class="sy0">-></span><span class="me1">lifeTime</span> <span class="sy0">=</span> <a href="http://www.php.net/get_cfg_var"><span class="kw3">get_cfg_var</span></a><span class="br0">&#40;</span><span class="st0">"session.gc_maxlifetime"</span><span class="br0">&#41;</span><span class="sy0">;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">// open database-connection </span><br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="re0">$dbHandle</span> <span class="sy0">=</span> <span class="sy0">@</span><a href="http://www.php.net/mysql_connect"><span class="kw3">mysql_connect</span></a><span class="br0">&#40;</span><span class="st0">"server"</span><span class="sy0">,</span><span class="st0">"user"</span><span class="sy0">,</span><span class="st0">"password"</span><span class="br0">&#41;</span><span class="sy0">;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="re0">$dbSel</span> <span class="sy0">=</span> <span class="sy0">@</span><a href="http://www.php.net/mysql_select_db"><span class="kw3">mysql_select_db</span></a><span class="br0">&#40;</span><span class="st0">"database"</span><span class="sy0">,</span><span class="re0">$dbHandle</span><span class="br0">&#41;</span><span class="sy0">;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">// return success </span><br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$dbHandle</span> <span class="sy0">||</span> <span class="sy0">!</span><span class="re0">$dbSel</span><span class="br0">&#41;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="re0">$this</span><span class="sy0">-></span><span class="me1">dbHandle</span> <span class="sy0">=</span> <span class="re0">$dbHandle</span><span class="sy0">;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">return</span> <span class="kw4">true</span><span class="sy0">;</span> <br /> &nbsp; &nbsp;<span class="br0">&#125;</span> <br /> &nbsp; &nbsp;<span class="kw2">function</span> close<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="re0">$this</span><span class="sy0">-></span><span class="me1">gc</span><span class="br0">&#40;</span><a href="http://www.php.net/ini_get"><span class="kw3">ini_get</span></a><span class="br0">&#40;</span><span class="st_h">'session.gc_maxlifetime'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">// close database-connection </span><br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">return</span> <span class="sy0">@</span><a href="http://www.php.net/mysql_close"><span class="kw3">mysql_close</span></a><span class="br0">&#40;</span><span class="re0">$this</span><span class="sy0">-></span><span class="me1">dbHandle</span><span class="br0">&#41;</span><span class="sy0">;</span> <br /> &nbsp; &nbsp;<span class="br0">&#125;</span> <br /> &nbsp; &nbsp;<span class="kw2">function</span> read<span class="br0">&#40;</span><span class="re0">$sessID</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">// fetch session-data </span><br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="re0">$res</span> <span class="sy0">=</span> <a href="http://www.php.net/mysql_query"><span class="kw3">mysql_query</span></a><span class="br0">&#40;</span><span class="st0">"SELECT session_data AS d FROM ws_sessions <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHERE session_id = '<span class="es4">$sessID</span>' <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;AND session_expires > "</span><span class="sy0">.</span><a href="http://www.php.net/time"><span class="kw3">time</span></a><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">,</span><span class="re0">$this</span><span class="sy0">-></span><span class="me1">dbHandle</span><span class="br0">&#41;</span><span class="sy0">;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">// return data or an empty string at failure </span><br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$row</span> <span class="sy0">=</span> <a href="http://www.php.net/mysql_fetch_assoc"><span class="kw3">mysql_fetch_assoc</span></a><span class="br0">&#40;</span><span class="re0">$res</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">return</span> <span class="re0">$row</span><span class="br0">&#91;</span><span class="st_h">'d'</span><span class="br0">&#93;</span><span class="sy0">;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">return</span> <span class="st0">""</span><span class="sy0">;</span> <br /> &nbsp; &nbsp;<span class="br0">&#125;</span> <br /> &nbsp; &nbsp;<span class="kw2">function</span> write<span class="br0">&#40;</span><span class="re0">$sessID</span><span class="sy0">,</span><span class="re0">$sessData</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">// new session-expire-time </span><br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="re0">$newExp</span> <span class="sy0">=</span> <a href="http://www.php.net/time"><span class="kw3">time</span></a><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="re0">$this</span><span class="sy0">-></span><span class="me1">lifeTime</span><span class="sy0">;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">// is a session with this id in the database? </span><br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="re0">$res</span> <span class="sy0">=</span> <a href="http://www.php.net/mysql_query"><span class="kw3">mysql_query</span></a><span class="br0">&#40;</span><span class="st0">"SELECT * FROM ws_sessions <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHERE session_id = '<span class="es4">$sessID</span>'"</span><span class="sy0">,</span><span class="re0">$this</span><span class="sy0">-></span><span class="me1">dbHandle</span><span class="br0">&#41;</span><span class="sy0">;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">// if yes, </span><br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">if</span><span class="br0">&#40;</span><a href="http://www.php.net/mysql_num_rows"><span class="kw3">mysql_num_rows</span></a><span class="br0">&#40;</span><span class="re0">$res</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">// ...update session-data </span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<a href="http://www.php.net/mysql_query"><span class="kw3">mysql_query</span></a><span class="br0">&#40;</span><span class="st0">"UPDATE ws_sessions <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SET session_expires = '<span class="es4">$newExp</span>', <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;session_data = '<span class="es4">$sessData</span>' <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHERE session_id = '<span class="es4">$sessID</span>'"</span><span class="sy0">,</span><span class="re0">$this</span><span class="sy0">-></span><span class="me1">dbHandle</span><span class="br0">&#41;</span><span class="sy0">;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">// if something happened, return true </span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">if</span><span class="br0">&#40;</span><a href="http://www.php.net/mysql_affected_rows"><span class="kw3">mysql_affected_rows</span></a><span class="br0">&#40;</span><span class="re0">$this</span><span class="sy0">-></span><span class="me1">dbHandle</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">return</span> <span class="kw4">true</span><span class="sy0">;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="br0">&#125;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">// if no session-data was found, </span><br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">else</span> <span class="br0">&#123;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">// create a new row </span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<a href="http://www.php.net/mysql_query"><span class="kw3">mysql_query</span></a><span class="br0">&#40;</span><span class="st0">"INSERT INTO ws_sessions ( <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;session_id, <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;session_expires, <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;session_data) <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;VALUES( <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'<span class="es4">$sessID</span>', <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'<span class="es4">$newExp</span>', <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;'<span class="es4">$sessData</span>')"</span><span class="sy0">,</span><span class="re0">$this</span><span class="sy0">-></span><span class="me1">dbHandle</span><span class="br0">&#41;</span><span class="sy0">;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">// if row was created, return true </span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">if</span><span class="br0">&#40;</span><a href="http://www.php.net/mysql_affected_rows"><span class="kw3">mysql_affected_rows</span></a><span class="br0">&#40;</span><span class="re0">$this</span><span class="sy0">-></span><span class="me1">dbHandle</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">return</span> <span class="kw4">true</span><span class="sy0">;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="br0">&#125;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">// an unknown error occured </span><br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span> <br /> &nbsp; &nbsp;<span class="br0">&#125;</span> <br /> &nbsp; &nbsp;<span class="kw2">function</span> destroy<span class="br0">&#40;</span><span class="re0">$sessID</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">// delete session-data </span><br /> &nbsp; &nbsp; &nbsp; &nbsp;<a href="http://www.php.net/mysql_query"><span class="kw3">mysql_query</span></a><span class="br0">&#40;</span><span class="st0">"DELETE FROM ws_sessions WHERE session_id = '<span class="es4">$sessID</span>'"</span><span class="sy0">,</span><span class="re0">$this</span><span class="sy0">-></span><span class="me1">dbHandle</span><span class="br0">&#41;</span><span class="sy0">;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">// if session was deleted, return true, </span><br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">if</span><span class="br0">&#40;</span><a href="http://www.php.net/mysql_affected_rows"><span class="kw3">mysql_affected_rows</span></a><span class="br0">&#40;</span><span class="re0">$this</span><span class="sy0">-></span><span class="me1">dbHandle</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">return</span> <span class="kw4">true</span><span class="sy0">;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">// ...else return false </span><br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span> <br /> &nbsp; &nbsp;<span class="br0">&#125;</span> <br /> &nbsp; &nbsp;<span class="kw2">function</span> gc<span class="br0">&#40;</span><span class="re0">$sessMaxLifeTime</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">// delete old sessions </span><br /> &nbsp; &nbsp; &nbsp; &nbsp;<a href="http://www.php.net/mysql_query"><span class="kw3">mysql_query</span></a><span class="br0">&#40;</span><span class="st0">"DELETE FROM ws_sessions WHERE session_expires < "</span><span class="sy0">.</span><a href="http://www.php.net/time"><span class="kw3">time</span></a><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">,</span><span class="re0">$this</span><span class="sy0">-></span><span class="me1">dbHandle</span><span class="br0">&#41;</span><span class="sy0">;</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">// return affected rows </span><br /> &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">return</span> <a href="http://www.php.net/mysql_affected_rows"><span class="kw3">mysql_affected_rows</span></a><span class="br0">&#40;</span><span class="re0">$this</span><span class="sy0">-></span><span class="me1">dbHandle</span><span class="br0">&#41;</span><span class="sy0">;</span> <br /> &nbsp; &nbsp;<span class="br0">&#125;</span> <br /> <span class="br0">&#125;</span> <br /> <span class="re0">$session</span> <span class="sy0">=</span> <span class="kw2">new</span> session<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span> <br /> <a href="http://www.php.net/session_set_save_handler"><span class="kw3">session_set_save_handler</span></a><span class="br0">&#40;</span><a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">&#40;</span><span class="sy0">&</span><span class="re0">$session</span><span class="sy0">,</span><span class="st0">"open"</span><span class="br0">&#41;</span><span class="sy0">,</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">&#40;</span><span class="sy0">&</span><span class="re0">$session</span><span class="sy0">,</span><span class="st0">"close"</span><span class="br0">&#41;</span><span class="sy0">,</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">&#40;</span><span class="sy0">&</span><span class="re0">$session</span><span class="sy0">,</span><span class="st0">"read"</span><span class="br0">&#41;</span><span class="sy0">,</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">&#40;</span><span class="sy0">&</span><span class="re0">$session</span><span class="sy0">,</span><span class="st0">"write"</span><span class="br0">&#41;</span><span class="sy0">,</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">&#40;</span><span class="sy0">&</span><span class="re0">$session</span><span class="sy0">,</span><span class="st0">"destroy"</span><span class="br0">&#41;</span><span class="sy0">,</span> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">&#40;</span><span class="sy0">&</span><span class="re0">$session</span><span class="sy0">,</span><span class="st0">"gc"</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span> <br /> <a href="http://www.php.net/session_start"><span class="kw3">session_start</span></a><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span> <br /> <span class="co1">// etc... </span><br /> <span class="sy1">?></span>
        </div>
      </td>
    </tr>
  </table>
</div>

<p>除了上述方法外还有其他办法可以保持Session的同步，可以参考<a href="http://www.fuchaoqun.com/2009/02/php-session-confuse/">PHP SESSION解惑</a>一文中第四部分“session的同步”。</p>

<p>下面再谈谈Session ID的传递方式：Cookie和URL传递。<br />
Cookie是比较常用的方式，在这种模式下，启动Session后服务器会在HTTP Response中自动加上header(‘Set-Cookie: session_name()=session_id(); path=/’)，并在以后的请求中加上这个Cookie。当从该页跳转到的新页面并调用session_start()后，PHP将检查与给定ID相关联的服务器端存贮的session数据，如果没找到，则新建一个数据集。但是有一点，这种传递方式必须在用户浏览器开启Cookie的情况下才可用，如果万一用户关闭了Cookie，那么只好选择另外一种通过URL参数传递Session ID。<br />
开启URL传递需要在php.ini中设置session.use_trans_sid（文档中提示使用这种方式会有安全风险，因为它显示地将Session ID放在url中，所以除非迫不得已不要选择此方式），并在代码中做如下修改：</p>

<div class="codecolorer-container php blackboard" style="overflow:auto;white-space:nowrap;">
  <table cellspacing="0" cellpadding="0">
    <tr>
      <td class="line-numbers">
        <div>
          1<br />2<br />3<br />4<br />5<br />6<br />
        </div>
      </td>
      
      <td>
        <div class="php codecolorer">
          <span class="co1">// 如果客户端使用cookie,可直接传递session到page2.php</span><br /> <br /> <span class="kw1">echo</span> <span class="st_h">'<br /><a href="page2.php">page 2</a>'</span><span class="sy0">;</span><br /> &nbsp;<br /> <span class="co1">// 如果客户端禁用cookie</span><br /> <span class="kw1">echo</span> <span class="st_h">'<br /><a href="page2.php?'</span> <span class="sy0">.</span> SID <span class="sy0">.</span> <span class="st_h">'">page 2</a>'</span><span class="sy0">;</span>
        </div>
      </td>
    </tr>
  </table>
</div>

<p>/*<br />
默认php5.2.1下,SID只有在cookie被写入的同时才会有值,如果该session<br />
对应的cookie已经存在,那么SID将为(未定义)空<br />
*/<br />
更新2010－12－28：<br />
如果php使用默认的file方式存储session，还要注意lock问题。因为php会lock住session文件直到这个session关闭，所以如果你的应用中涉及iframe、下载、Comet或者用户在同一个浏览器打开多个tab等等多个并行请求都要操作session时，就可能会遇到由于lock影响用户操作的情况。一个简单的解决办法就是在操作完session时，及时调用session_commit()或session_write_close()来关闭session，从而释放锁。（注意在关闭session后不要再调用任何session相关的函数）</p>

<p>关于Session的内容还有很多，具体可查看<a href="http://www.php.net/manual/en/book.session.php">官方手册</a>，如果有新的总结会继续更新。<br />
原文链接：<a href="http://imdonkey.com/blog/archives/255">http://imdonkey.com/blog/archives/255</a></p>

					</div>
			  </div>
			  <div class="footer">
				  标签: 
				         <a href="/tags/php">PHP</a> &nbsp;
				      
				         <a href="/tags/session">SESSION</a> &nbsp;
				      
			  </div>
	  	 </div>
	</div>
	<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script> 
	<script type="text/javascript">
	$(document).ready(function() {
	  $('code').each(function(i, block) {
	    hljs.highlightBlock(block);
	  });
	}); 
	</script>
   </body>
</html>
 
